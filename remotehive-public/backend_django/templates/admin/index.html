{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    :root {
        --primary: #4f46e5;
        --secondary: #6366f1;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #3b82f6;
        --purple: #8b5cf6;
        --bg-card: #ffffff;
        --text-main: #1f2937;
        --text-muted: #6b7280;
        --bg-body: #f3f4f6;
    }

    body {
        background-color: var(--bg-body);
    }

    .dashboard-container {
        padding: 24px 0;
        font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
        max-width: 1400px;
        margin: 0 auto;
    }

    /* --- Filter Bar (Salesforce-like) --- */
    .filter-bar {
        background: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        border: 1px solid #e5e7eb;
    }

    .filter-group {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .filter-select {
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.9rem;
        color: var(--text-main);
        background-color: white;
        cursor: pointer;
        min-width: 150px;
    }
    .filter-select:focus {
        outline: none;
        border-color: var(--primary);
        ring: 2px solid var(--primary);
    }

    .refresh-btn {
        background: none;
        border: 1px solid #d1d5db;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        color: var(--text-muted);
        transition: all 0.2s;
    }
    .refresh-btn:hover {
        background: #f9fafb;
        color: var(--primary);
        border-color: var(--primary);
    }
    
    .settings-btn {
        background: none;
        border: none;
        cursor: pointer;
        color: var(--text-muted);
        font-size: 1.2rem;
        padding: 8px;
    }
    .settings-btn:hover { color: var(--text-main); }

    /* --- Section Headers --- */
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 8px;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-main);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* --- Stats Grid --- */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 32px;
    }
    
    @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 768px) { .stats-grid { grid-template-columns: 1fr; } }

    .stat-card {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease;
        text-decoration: none !important;
        display: flex;
        flex-direction: column;
        cursor: pointer; /* Suggests clickability */
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.05);
        border-color: var(--primary);
    }

    .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        color: white;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-main);
        line-height: 1;
        margin-bottom: 4px;
    }

    .stat-label {
        font-size: 0.85rem;
        color: var(--text-muted);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .stat-footer {
        margin-top: auto;
        padding-top: 12px;
        font-size: 0.8rem;
        color: var(--primary);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 4px;
        opacity: 0.8;
    }

    /* --- Charts --- */
    .charts-row {
        display: grid;
        grid-template-columns: 2fr 1fr; /* Asymmetric grid like Salesforce */
        gap: 24px;
        margin-bottom: 32px;
    }
    
    @media (max-width: 1000px) { .charts-row { grid-template-columns: 1fr; } }

    .chart-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        border: 1px solid #e5e7eb;
        position: relative;
    }
    
    .chart-container-wrapper {
        position: relative;
        height: 300px;
        width: 100%;
        border: 1px solid #f3f4f6; /* Subtle internal border for chart area */
        border-radius: 8px;
        padding: 10px;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }
    
    .chart-title {
        font-size: 1rem;
        font-weight: 700;
        color: var(--text-main);
        margin: 0;
    }

    /* --- Modal --- */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    .modal-content {
        background: white;
        padding: 24px;
        border-radius: 12px;
        width: 400px;
        max-width: 90%;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
    .modal-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 16px;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 12px;
    }
    .modal-title { font-weight: 700; font-size: 1.1rem; }
    .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; }

    /* Gradients */
    .bg-blue { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
    .bg-indigo { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
    .bg-green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .bg-yellow { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .bg-red { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
    .bg-purple { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
    .bg-pink { background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); }
    .bg-teal { background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%); }

    /* Action Buttons */
    .action-btn {
        background: var(--primary);
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: background 0.2s;
    }
    .action-btn:hover { background: var(--secondary); }

</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    
    <!-- Filter Bar & Actions -->
    <div class="filter-bar">
        <div class="filter-group">
            <h2 class="section-title" style="margin-right: 20px;">Dashboard</h2>
            <select id="timeRangeFilter" class="filter-select" onchange="fetchDashboardData()">
                <option value="all">All Time</option>
                <option value="7d">Last 7 Days</option>
                <option value="30d">Last 30 Days</option>
                <option value="90d">Last 90 Days</option>
            </select>
            <button class="refresh-btn" onclick="fetchDashboardData()" title="Refresh Data">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        <div class="filter-group">
            <button class="settings-btn" onclick="toggleSettingsModal()">
                <i class="fas fa-cog"></i>
            </button>
            <a href="/admin/autoscraper/scrapersource/" class="action-btn">
                <i class="fas fa-cloud-download-alt"></i> Fetch Jobs
            </a>
            <a href="/admin/core/job/add/" class="action-btn" style="background: var(--success);">
                <i class="fas fa-plus"></i> Post Job
            </a>
        </div>
    </div>

    <!-- 1. KEY METRICS -->
    <div class="stats-grid" id="keyMetricsGrid">
        <!-- Live Jobs -->
        <a href="/admin/core/job/?status__exact=published" class="stat-card">
            <div class="stat-header">
                <div class="stat-label">Live Jobs</div>
                <div class="stat-icon bg-green"><i class="fas fa-globe"></i></div>
            </div>
            <div class="stat-value" id="val-jobs-published">--</div>
            <div class="stat-footer">View Details <i class="fas fa-arrow-right"></i></div>
        </a>

        <!-- Total Users -->
        <a href="/admin/auth/user/" class="stat-card">
            <div class="stat-header">
                <div class="stat-label">Total Users</div>
                <div class="stat-icon bg-blue"><i class="fas fa-users"></i></div>
            </div>
            <div class="stat-value" id="val-users-total">--</div>
            <div class="stat-footer">Manage Users <i class="fas fa-arrow-right"></i></div>
        </a>

        <!-- New Scraped Jobs -->
        <a href="/admin/autoscraper/scrapedjob/?status__exact=new" class="stat-card">
            <div class="stat-header">
                <div class="stat-label">New Scraped Jobs</div>
                <div class="stat-icon bg-red"><i class="fas fa-bolt"></i></div>
            </div>
            <div class="stat-value" id="val-scraped-new">--</div>
            <div class="stat-footer">Review & Approve <i class="fas fa-arrow-right"></i></div>
        </a>

        <!-- Active Employers -->
        <a href="/admin/core/employeruser/" class="stat-card">
            <div class="stat-header">
                <div class="stat-label">Active Employers</div>
                <div class="stat-icon bg-indigo"><i class="fas fa-building"></i></div>
            </div>
            <div class="stat-value" id="val-users-employers">--</div>
            <div class="stat-footer">View Employers <i class="fas fa-arrow-right"></i></div>
        </a>
    </div>

    <!-- 2. CHARTS ROW -->
    <div class="charts-row">
        <!-- Job Status Chart -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">Job Pipeline</h3>
                <i class="fas fa-ellipsis-h" style="color: #9ca3af; cursor: pointer;"></i>
            </div>
            <div class="chart-container-wrapper">
                <canvas id="jobStatusChart"></canvas>
            </div>
        </div>

        <!-- User Distribution Chart -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">User Segments</h3>
                <i class="fas fa-ellipsis-h" style="color: #9ca3af; cursor: pointer;"></i>
            </div>
            <div class="chart-container-wrapper" style="height: 300px;">
                <canvas id="userDistributionChart"></canvas>
            </div>
        </div>
    </div>

    <!-- 3. SECONDARY METRICS -->
    <div class="section-header">
        <h2 class="section-title" style="font-size: 1.1rem;">
            Data & Scraper Stats
        </h2>
    </div>

    <div class="stats-grid">
        <!-- Draft Jobs -->
        <a href="/admin/core/job/?status__exact=draft" class="stat-card">
            <div class="stat-header">
                <div class="stat-label">Draft Jobs</div>
                <div class="stat-icon bg-yellow"><i class="fas fa-edit"></i></div>
            </div>
            <div class="stat-value" id="val-jobs-draft">--</div>
            <div class="stat-footer">Manage Drafts <i class="fas fa-arrow-right"></i></div>
        </a>

        <!-- Total Scraped -->
        <a href="/admin/autoscraper/scrapedjob/" class="stat-card">
            <div class="stat-header">
                <div class="stat-label">Total Scraped</div>
                <div class="stat-icon bg-purple"><i class="fas fa-database"></i></div>
            </div>
            <div class="stat-value" id="val-scraped-total">--</div>
            <div class="stat-footer">View History <i class="fas fa-arrow-right"></i></div>
        </a>

        <!-- Job Seekers -->
        <a href="/admin/core/jobseekeruser/" class="stat-card">
            <div class="stat-header">
                <div class="stat-label">Job Seekers</div>
                <div class="stat-icon bg-pink"><i class="fas fa-user-graduate"></i></div>
            </div>
            <div class="stat-value" id="val-users-seekers">--</div>
            <div class="stat-footer">View Seekers <i class="fas fa-arrow-right"></i></div>
        </a>
        
         <!-- Leads -->
        <a href="/admin/leads/lead/" class="stat-card">
            <div class="stat-header">
                <div class="stat-label">Total Leads</div>
                <div class="stat-icon bg-teal"><i class="fas fa-funnel-dollar"></i></div>
            </div>
            <div class="stat-value" id="val-leads">--</div>
            <div class="stat-footer">View Leads <i class="fas fa-arrow-right"></i></div>
        </a>
    </div>

</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Dashboard Settings</h3>
            <button class="close-modal" onclick="toggleSettingsModal()">&times;</button>
        </div>
        <div style="margin-bottom: 20px;">
            <p style="margin-bottom: 10px; color: var(--text-muted);">Visible Widgets</p>
            <label style="display: block; margin-bottom: 8px;">
                <input type="checkbox" checked disabled> Key Metrics
            </label>
            <label style="display: block; margin-bottom: 8px;">
                <input type="checkbox" checked> Charts
            </label>
            <label style="display: block; margin-bottom: 8px;">
                <input type="checkbox" checked> Scraper Stats
            </label>
        </div>
        <button class="action-btn" onclick="toggleSettingsModal()" style="width: 100%; justify-content: center;">Save Preferences</button>
    </div>
</div>

<script>
    // --- Global Chart Instances ---
    let jobChart = null;
    let userChart = null;

    // --- Fetch Data Logic ---
    async function fetchDashboardData() {
        const range = document.getElementById('timeRangeFilter').value;
        const refreshBtn = document.querySelector('.refresh-btn i');
        
        // Add spin animation
        refreshBtn.classList.add('fa-spin');
        
        try {
            const response = await fetch(`/admin/api/dashboard-stats/?range=${range}`);
            const data = await response.json();
            
            updateMetrics(data);
            updateCharts(data);
            
        } catch (error) {
            console.error("Error fetching dashboard stats:", error);
        } finally {
            refreshBtn.classList.remove('fa-spin');
        }
    }

    function updateMetrics(data) {
        // Helper to animate numbers
        const animateValue = (id, end) => {
            const obj = document.getElementById(id);
            if(!obj) return;
            obj.innerText = end || 0;
        };

        animateValue('val-jobs-published', data.jobs_internal_published);
        animateValue('val-users-total', data.users_total);
        animateValue('val-scraped-new', data.jobs_scraped_new);
        animateValue('val-users-employers', data.users_employers);
        
        animateValue('val-jobs-draft', data.jobs_internal_draft);
        animateValue('val-scraped-total', data.jobs_scraped_total);
        animateValue('val-users-seekers', data.users_jobseekers);
        animateValue('val-leads', data.leads_count);
    }

    function updateCharts(data) {
        // 1. Update Job Status Chart
        const jobData = [
            data.jobs_internal_published || 0,
            data.jobs_internal_draft || 0,
            data.jobs_scraped_new || 0,
            data.jobs_scraped_approved || 0
        ];
        
        if (jobChart) {
            jobChart.data.datasets[0].data = jobData;
            jobChart.update();
        } else {
            initJobChart(jobData);
        }

        // 2. Update User Chart
        const employers = data.users_employers || 0;
        const seekers = data.users_jobseekers || 0;
        const total = data.users_total || 0;
        const others = Math.max(0, total - (employers + seekers));
        
        const userData = [employers, seekers, others];
        
        if (userChart) {
            userChart.data.datasets[0].data = userData;
            userChart.update();
        } else {
            initUserChart(userData);
        }
    }

    // --- Chart Initializers ---
    function initJobChart(data) {
        const ctx = document.getElementById('jobStatusChart').getContext('2d');
        jobChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Published', 'Draft', 'Scraped (New)', 'Scraped (Approved)'],
                datasets: [{
                    label: 'Count',
                    data: data,
                    backgroundColor: [
                        '#10b981', '#f59e0b', '#ef4444', '#3b82f6'
                    ],
                    borderRadius: 6,
                    maxBarThickness: 50, // Limit width but allow scaling
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        grid: { borderDash: [2, 4], color: '#f3f4f6' },
                        ticks: { font: { size: 11 } }
                    },
                    x: { 
                        grid: { display: false },
                        ticks: { font: { size: 11 } }
                    }
                },
                layout: {
                    padding: { left: 10, right: 10, top: 10, bottom: 10 }
                },
                onClick: (evt, activeElements) => {
                    if (activeElements.length > 0) {
                        const index = activeElements[0].index;
                        const label = jobChart.data.labels[index];
                        // Drill down logic
                        if(label.includes('Published')) window.location.href = '/admin/core/job/?status__exact=published';
                        if(label.includes('Draft')) window.location.href = '/admin/core/job/?status__exact=draft';
                        if(label.includes('New')) window.location.href = '/admin/autoscraper/scrapedjob/?status__exact=new';
                        if(label.includes('Approved')) window.location.href = '/admin/autoscraper/scrapedjob/?status__exact=approved';
                    }
                }
            }
        });
    }

    function initUserChart(data) {
        const ctx = document.getElementById('userDistributionChart').getContext('2d');
        userChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Employers', 'Job Seekers', 'Admins/Others'],
                datasets: [{
                    data: data,
                    backgroundColor: ['#6366f1', '#ec4899', '#9ca3af'],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 8 } }
                },
                onClick: (evt, activeElements) => {
                    if (activeElements.length > 0) {
                        const index = activeElements[0].index;
                        if(index === 0) window.location.href = '/admin/core/employeruser/';
                        if(index === 1) window.location.href = '/admin/core/jobseekeruser/';
                        if(index === 2) window.location.href = '/admin/auth/user/';
                    }
                }
            }
        });
    }

    // --- UI Helpers ---
    function toggleSettingsModal() {
        const modal = document.getElementById('settingsModal');
        modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
    }

    // Close modal on outside click
    window.onclick = function(event) {
        const modal = document.getElementById('settingsModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
        // Load initial data (using the template context as fallback or fetch immediately)
        // Since we want the filter to work, let's just trigger a fetch with 'all'
        fetchDashboardData();
    });

</script>
{% endblock %}
